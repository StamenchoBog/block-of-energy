---
interface Props {
    title: string;
    value: string;
    unit: string;
    description?: string;
    trend?: 'up' | 'down' | 'stable';
    trendValue?: string;
    icon?: string;
    loading?: boolean;
}

const { title, value, unit, description, trend, trendValue, icon, loading = false } = Astro.props;

// Format large numbers
const formatValue = (val: string) => {
    const num = parseFloat(val);
    if (isNaN(num)) return val;
    
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toLocaleString();
};

const formattedValue = formatValue(value);

// Determine status based on the metric type
const getStatusColor = (title: string, value: string) => {
    const val = parseFloat(value);
    
    switch (title.toLowerCase()) {
        case 'power':
            return val > 800 ? 'text-red-600 : 
                   val > 400 ? 'text-yellow-600 : 
                   'text-green-600
        case 'voltage':
            return val < 220 || val > 240 ? 'text-red-600 : 'text-green-600
        case 'power factor':
            return val < 0.8 ? 'text-red-600 : 
                   val < 0.9 ? 'text-yellow-600 : 
                   'text-green-600
        default:
            return 'text-gray-900
    }
};

const statusColor = getStatusColor(title, value);
---

<div class="metric-card group">
    {loading ? (
        <!-- Loading skeleton -->
        <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-3"></div>
            <div class="h-8 bg-gray-200 rounded w-1/2 mb-2"></div>
            {description && <div class="h-3 bg-gray-200 rounded w-1/3"></div>}
        </div>
    ) : (
        <>
            <!-- Header with icon -->
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide">
                    {title}
                </h3>
                {icon && (
                    <div class="w-6 h-6 text-gray-400
                        <svg class="w-full h-full" fill="currentColor" viewBox="0 0 24 24">
                            <!-- Dynamic icon based on metric type -->
                            {title.toLowerCase().includes('power') && (
                                <path d="M11.5,1 L6,9 L10,9 L12.5,23 L18,15 L14,15 L11.5,1 Z"/>
                            )}
                            {title.toLowerCase().includes('voltage') && (
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            )}
                            {title.toLowerCase().includes('energy') && (
                                <path d="M20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4C12.76,4 13.5,4.11 14.2,4.31L15.77,2.74C14.61,2.26 13.34,2 12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12M7.91,10.08L6.5,11.5L11,16L21,6L19.59,4.58L11,13.17L7.91,10.08Z"/>
                            )}
                            {!title.toLowerCase().includes('power') && !title.toLowerCase().includes('voltage') && !title.toLowerCase().includes('energy') && (
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                            )}
                        </svg>
                    </div>
                )}
            </div>

            <!-- Value with trend -->
            <div class="flex items-baseline justify-between">
                <div class="flex items-baseline space-x-2">
                    <span class={`text-3xl font-bold ${statusColor} transition-colors duration-300`}>
                        {formattedValue}
                    </span>
                    {unit && (
                        <span class="text-lg font-medium text-gray-500
                            {unit}
                        </span>
                    )}
                </div>
                
                <!-- Trend indicator -->
                {trend && trendValue && (
                    <div class={`flex items-center space-x-1 text-sm font-medium ${
                        trend === 'up' ? 'text-green-600 :
                        trend === 'down' ? 'text-red-600 :
                        'text-gray-500
                    }`}>
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            {trend === 'up' && (
                                <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            )}
                            {trend === 'down' && (
                                <path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            )}
                            {trend === 'stable' && (
                                <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            )}
                        </svg>
                        <span>{trendValue}</span>
                    </div>
                )}
            </div>

            <!-- Description -->
            {description && (
                <p class="mt-3 text-sm text-gray-600
                    {description}
                </p>
            )}
        </>
    )}
    
    <!-- Hover effect overlay -->
    <div class="absolute inset-0 bg-gradient-to-r from-green-500/0 to-green-500/5 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
</div>
